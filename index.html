<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPHACO Admin | Quản trị Sổ Tang</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="CPH LOGO 1.png">
    
    <script src="https://cdn.tiny.cloud/1/f3c6icc3n2mp5e2mg4cnf8ck0is7qgtrnyr13ut4rpys3645/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --cph-blue: #0099D8;
            --cph-blue-dark: #007bb0;
            --sidebar-width: 260px;
            --sidebar-bg: #ffffff;
            --body-bg: #f8fafc;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--body-bg); color: #1e293b; overflow-x: hidden; }
        .tox-notifications-container, .tox-statusbar__branding { display: none !important; }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background-color: var(--sidebar-bg); border-right: 1px solid #e2e8f0; 
            position: fixed; top: 0; left: 0; padding: 24px 16px; z-index: 1000; 
            display: flex; flex-direction: column; transition: transform 0.3s ease-in-out;
        }
        .brand-logo { text-decoration: none; display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .brand-logo img { height: 80px; object-fit: contain; margin-bottom: 10px; }
        .brand-text { font-family: 'Roboto', sans-serif; font-weight: 700; color: var(--cph-blue); font-size: 1.1rem; text-transform: uppercase; }
        .nav-link { color: #334155; padding: 14px 20px; border-radius: 8px; margin-bottom: 8px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background-color: #f1f5f9; color: var(--cph-blue); }
        .nav-link.active { background-color: #e0f2fe; color: var(--cph-blue); font-weight: 600; }

        /* MAIN */
        .main-wrapper { margin-left: var(--sidebar-width); padding: 40px; min-height: 100vh; transition: margin-left 0.3s ease-in-out; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: #0f172a; margin-bottom: 5px; }
        .card { background: white; border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04); margin-bottom: 24px; overflow: hidden; }
        .card-body { padding: 30px; }
        .btn-primary { background-color: var(--cph-blue); border-color: var(--cph-blue); }
        .btn-primary:hover { background-color: var(--cph-blue-dark); border-color: var(--cph-blue-dark); }

        /* TABLES & FORMS */
        .custom-table th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 15px 20px; white-space: nowrap; }
        .custom-table td { padding: 15px 20px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        .dynamic-row { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        
        /* UI UTILS */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1060; }
        .mobile-header { display: none; padding: 15px 20px; background: white; border-bottom: 1px solid #e2e8f0; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 900; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 990; }

        /* STANDEE EXPORT TEMPLATE (ẨN) - Giao diện cũ (Dark) */
        #export-container-old {
            position: fixed; top: 0; left: -9999px; width: 1080px; height: 1920px; 
            background: linear-gradient(180deg, #101828 0%, #05080F 100%); 
            color: #ffffff; padding: 100px 80px; box-sizing: border-box; 
            font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; align-items: center;
            z-index: -100;
        }
        .standee-top-text { font-size: 48px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; color: #fbbf24; margin-bottom: 10px; }
        .standee-title { font-size: 72px; font-weight: 700; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 80px; color: #ffffff; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .st-portrait-frame { padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin-bottom: 50px; }
        .st-portrait { width: 500px; height: 680px; object-fit: cover; display: block; background: #000; }
        .st-info { text-align: center; margin-bottom: 20px; }
        .st-name { font-size: 64px; font-weight: 700; text-transform: uppercase; color: #ffffff; margin-bottom: 15px; }
        .st-years { font-size: 36px; color: #94a3b8; font-weight: 400; }
        .st-qr-section { margin-top: 20px; display: flex; justify-content: center; width: 100%; }
        .st-qr-text { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 20px; }
        .st-qr-box { background: #ffffff; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .st-qr-text h3 { font-size: 32px; color: #fbbf24; margin: 0; font-weight: 700; text-transform: uppercase; }
        .st-qr-text p { font-size: 20px; color: #e2e8f0; margin: 0; line-height: 1.5; }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-wrapper { margin-left: 0; padding: 20px; margin-top: 60px; }
            .mobile-header { display: flex; }
            .sidebar-overlay.active { display: block; }
            .table-responsive { overflow-x: auto; }
            .dynamic-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>

<body>

    <div id="loading"><div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <div class="mobile-header">
        <div class="d-flex align-items-center gap-2">
            <img src="CPH LOGO 1.png" alt="Logo" style="height: 32px;">
            <span class="fw-bold text-primary">CPHACO ADMIN</span>
        </div>
        <button class="btn btn-light border" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="d-flex justify-content-between align-items-center d-lg-none mb-3">
            <span class="text-muted fw-bold">MENU</span>
            <button class="btn btn-sm btn-light" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <a href="#" class="brand-logo d-none d-lg-flex">
            <img src="CPH LOGO 1.png" alt="CPHACO Logo">
            <span class="brand-text">Admin Portal</span>
        </a>
        <div class="nav flex-column">
            <a id="nav-profiles" class="nav-link active" onclick="switchTab('profiles')"><i class="fas fa-list-alt"></i><span>Danh sách Hồ Sơ</span></a>
            <a id="nav-create" class="nav-link" onclick="switchTab('create', true)"><i class="fas fa-user-plus"></i><span>Thêm Mới / Sửa</span></a>
            <a id="nav-slideshow" class="nav-link" onclick="switchTab('slideshow')"><i class="fas fa-play-circle"></i><span>Cấu hình Trình chiếu</span></a>
        </div>
        <div class="mt-auto d-lg-none text-center p-3 text-muted small border-top">
            &copy; 2025 CPHACO
        </div>
    </nav>

    <div class="main-wrapper">
        
        <div id="tab-profiles">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center page-header gap-3">
                <div><h1 class="page-title">Quản lý Trang Tưởng Niệm</h1><p class="text-muted mb-0">Hệ thống Sổ tang điện tử.</p></div>
                <button class="btn btn-primary shadow-sm w-100 w-md-auto" onclick="switchTab('create', true)"><i class="fas fa-plus me-2"></i> Tạo mới</button>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table custom-table mb-0">
                        <thead><tr><th>#</th><th>Mã Hồ Sơ</th><th>Người mất</th><th>Ngày tạo</th><th class="text-end">Thao tác</th></tr></thead>
                        <tbody id="profiles-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-create" style="display:none;">
            <div class="d-flex justify-content-between align-items-center page-header">
                <div><h1 class="page-title" id="form-title">Tạo Hồ Sơ Mới</h1><p class="text-muted d-none d-md-block">Nhập thông tin chi tiết để hiển thị.</p></div>
                <button class="btn btn-outline-secondary bg-white" onclick="switchTab('profiles')"><i class="fas fa-arrow-left me-2"></i> Quay lại</button>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <form id="profileForm">
                                <h5 class="mb-4 text-primary fw-bold">Thông tin cơ bản</h5>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Mã Hồ Sơ <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="job_id" placeholder="Tự động tạo..." required readonly>
                                        <div class="form-text text-muted small">Mã dùng cho link QR (Không sửa được).</div>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">Họ và Tên <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control fw-bold" id="full_name" placeholder="VD: Hoàng Nam Tiến" required oninput="generateIdFromName(this.value)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Niên khóa</label>
                                        <input type="text" class="form-control" id="date_range" placeholder="1969 - 2025">
                                    </div>
                                </div>
                                <div class="row g-4 mb-5">
                                    <div class="col-md-6"><label class="form-label">Avatar URL</label><input type="text" class="form-control" id="avatar_url"></div>
                                    <div class="col-md-6"><label class="form-label">Cover URL</label><input type="text" class="form-control" id="cover_url"></div>
                                </div>
                                <h5 class="mb-4 text-primary fw-bold">Nội dung chi tiết</h5>
                                <div class="mb-4"><label class="form-label">Tiểu sử (Web)</label><textarea id="biography_editor"></textarea></div>
                                <div class="row g-4 mb-4">
                                    <div class="col-lg-6">
                                        <label class="form-label d-flex justify-content-between align-items-center">
                                            Danh sách Chức vụ (TV)
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRoleRow()"><i class="fas fa-plus"></i> Thêm</button>
                                        </label>
                                        <div id="roles-wrapper" class="border rounded p-3 bg-white" style="min-height: 200px; max-height: 400px; overflow-y: auto;"></div>
                                    </div>
                                    <div class="col-lg-6">
                                        <label class="form-label d-flex justify-content-between align-items-center">
                                            Địa điểm tổ chức (TV)
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLocationRow()"><i class="fas fa-plus"></i> Thêm</button>
                                        </label>
                                        <div id="locations-wrapper" class="border rounded p-3 bg-white" style="min-height: 200px; max-height: 400px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end gap-2 pt-4 border-top">
                                    <button type="button" class="btn btn-light px-4" onclick="switchTab('profiles')">Hủy</button>
                                    <button type="submit" class="btn btn-primary px-5 shadow w-100 w-md-auto">Lưu Hồ Sơ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-slideshow" style="display:none;">
            <div class="d-flex justify-content-between align-items-center page-header">
                <div><h1 class="page-title">Cấu hình Trình Chiếu</h1><p class="text-muted">Chọn các hồ sơ để hiển thị liên tục trên màn hình Standee.</p></div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="mb-3 fw-bold text-primary">Danh sách hồ sơ</h5>
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table custom-table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50"><input type="checkbox" id="check-all" onclick="toggleAllSlides(this)"></th>
                                            <th>Người mất</th>
                                            <th>Mã Hồ sơ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="slideshow-table-body">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="mb-3 fw-bold text-primary">Cài đặt phát</h5>
                            <div class="mb-3">
                                <label class="form-label">Thời gian mỗi trang (giây)</label>
                                <input type="number" id="slide-interval" class="form-control" value="30" min="5">
                            </div>
                            <div class="alert alert-warning small">
                                <i class="fas fa-tv me-1"></i>
                                <strong>Lưu ý:</strong> Giao diện trình chiếu được thiết kế dọc (9:16). Thích hợp nhất khi chiếu lên màn hình dọc (Standee) hoặc TV xoay dọc.
                            </div>
                            <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" onclick="startSlideshow()">
                                <i class="fas fa-play me-2"></i> BẮT ĐẦU TRÌNH CHIẾU
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="tributesModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-light"><h5 class="modal-title fw-bold text-dark">Quản lý Sổ Tang</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="table-responsive" style="height: 100%; max-height: 70vh; overflow-y: auto;"><table class="table custom-table table-striped mb-0"><thead><tr><th>Người gửi</th><th>Nội dung</th><th>Ngày</th><th></th></tr></thead><tbody id="tributes-table-body"></tbody></table></div></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0"><h5 class="modal-title text-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Xác nhận xóa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="mb-0 text-muted" id="confirm-message">...</p></div><div class="modal-footer border-0 justify-content-center pb-4"><button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger px-4" id="btn-confirm-action">Xóa ngay</button></div></div></div></div>

    <div id="export-container-old">
        <div class="standee-top-text">HOA VIÊN BÌNH DƯƠNG</div>
        <div class="standee-title">TƯỞNG NIỆM</div>
        <div class="st-portrait-frame"><img id="export-avatar-old" class="st-portrait" src="" alt="Avatar"></div>
        <div class="st-info"><div class="st-name" id="export-name-old">...</div><div class="st-years" id="export-years-old">...</div></div>
        <div class="st-qr-section"><div class="st-qr-text"><h3>SỔ TANG ĐIỆN TỬ</h3><div class="st-qr-box" id="export-qrcode-old"></div><p>Quét mã để gửi lời chia buồn<br>Scan to visit memorial page</p></div></div>
    </div>

    <script>
        const API_BASE_URL = "https://cphaco-backend-api.onrender.com"; 
        let isEditMode = false; 
        let cachedProfiles = []; 

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
        document.querySelector('.sidebar-overlay').addEventListener('click', toggleSidebar);

        try { tinymce.init({ selector: '#biography_editor', height: 350, skin: 'oxide', plugins: 'lists link code', toolbar: 'undo redo | bold italic | bullist numlist', menubar: false }); } catch(e){}

        function generateIdFromName(name) {
            const idInput = document.getElementById('job_id');
            if (isEditMode) return; 
            let slug = name.toLowerCase();
            slug = slug.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
            slug = slug.replace(/[đĐ]/g, 'd'); 
            slug = slug.replace(/[^a-z0-9]/g, ''); 
            idInput.value = slug;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            const colorClass = type === 'success' ? 'bg-success' : 'bg-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            container.insertAdjacentHTML('beforeend', `<div id="${id}" class="toast align-items-center text-white ${colorClass} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body"><i class="fas ${icon} me-2"></i> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`);
            const toastEl = document.getElementById(id); const toast = new bootstrap.Toast(toastEl, { delay: 3000 }); toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        let confirmCallback = null;
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }
        document.getElementById('btn-confirm-action').addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
            const el = document.getElementById('confirmModal');
            const modal = bootstrap.Modal.getInstance(el);
            if (modal) modal.hide();
        });

        // HELPERS
        function addLocationRow(data = null) {
            const wrapper = document.getElementById('locations-wrapper');
            if(wrapper.querySelector('.empty-loc-msg')) wrapper.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'dynamic-row flex-column align-items-stretch';
            div.innerHTML = `<div class="d-flex justify-content-between align-items-start mb-2"><strong class="text-primary small"># Địa điểm</strong><button type="button" class="btn-remove-row" onclick="this.closest('.dynamic-row').remove()"><i class="fas fa-trash-alt"></i></button></div><div class="row g-2"><div class="col-md-6"><input type="text" class="form-control form-control-sm loc-name" placeholder="Tên" value="${data ? data.name : ''}"></div><div class="col-md-6"><input type="text" class="form-control form-control-sm loc-time" placeholder="Giờ" value="${data ? data.time : ''}"></div><div class="col-12"><input type="text" class="form-control form-control-sm loc-addr" placeholder="Địa chỉ" value="${data ? data.address : ''}"></div></div>`;
            wrapper.appendChild(div);
        }
        function getLocationsFromUI() {
            const locs = [];
            document.querySelectorAll('#locations-wrapper .dynamic-row').forEach(row => {
                const name = row.querySelector('.loc-name').value.trim();
                if(name) locs.push({ name, time: row.querySelector('.loc-time').value.trim(), address: row.querySelector('.loc-addr').value.trim() });
            });
            return locs;
        }
        function addRoleRow(roleText = "") {
            const wrapper = document.getElementById('roles-wrapper');
            if(wrapper.querySelector('.empty-role-msg')) wrapper.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'dynamic-row'; 
            div.innerHTML = `<input type="text" class="form-control form-control-sm role-input w-100" placeholder="Chức vụ..." value="${roleText}"><button type="button" class="btn-remove-row" onclick="this.closest('.dynamic-row').remove()"><i class="fas fa-times"></i></button>`;
            wrapper.appendChild(div);
        }
        function getRolesFromUI() {
            const roles = [];
            document.querySelectorAll('#roles-wrapper .role-input').forEach(input => { if(input.value.trim()) roles.push(input.value.trim()); });
            return roles;
        }

        // --- APP LOGIC ---
        function switchTab(tabName, forceReset = false) {
            document.querySelectorAll('.main-wrapper > div').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            if (window.innerWidth < 992) {
                document.querySelector('.sidebar').classList.remove('active');
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }

            if (tabName === 'profiles') {
                document.getElementById('tab-profiles').style.display = 'block';
                document.getElementById('nav-profiles').classList.add('active');
                loadProfilesList();
            } else if (tabName === 'create') {
                document.getElementById('tab-create').style.display = 'block';
                document.getElementById('nav-create').classList.add('active');
                if(forceReset || !document.getElementById('job_id').value) resetForm();
            } else if (tabName === 'slideshow') {
                document.getElementById('tab-slideshow').style.display = 'block';
                document.getElementById('nav-slideshow').classList.add('active');
                renderSlideshowList();
            }
        }

        async function loadProfilesList() {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/profiles`);
                const json = await res.json();
                cachedProfiles = json.items || []; 
                const tbody = document.getElementById('profiles-table-body');
                tbody.innerHTML = '';
                if (cachedProfiles.length > 0) {
                    cachedProfiles.forEach((p, index) => {
                        tbody.innerHTML += `
                        <tr>
                            <td class="text-muted fw-bold">${index + 1}</td>
                            <td>
                                <span class="badge bg-light text-dark border text-truncate" style="max-width: 100px;">${p.job_id}</span>
                                <div class="mt-1 d-flex gap-2">
                                    <a href="profile.html?job=${p.job_id}" target="_blank" class="text-decoration-none small"><i class="fas fa-link"></i> Web</a>
                                </div>
                            </td>
                            <td class="fw-bold text-primary">${p.full_name}</td>
                            <td class="text-muted small d-none d-md-table-cell">${new Date(p.created_at).toLocaleDateString('vi-VN')}</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-light btn-sm text-warning border" onclick="downloadStandeeOld('${p.job_id}')" title="Tải ảnh Standee (Cũ)">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="btn btn-light btn-sm text-primary" onclick="editProfile('${p.job_id}')"><i class="fas fa-pen"></i></button>
                                    <button class="btn btn-light btn-sm text-warning" onclick="manageTributes('${p.job_id}')"><i class="fas fa-comment-dots"></i></button>
                                    <button class="btn btn-light btn-sm text-danger" onclick="deleteProfile('${p.job_id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    });
                } else { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5">Chưa có dữ liệu</td></tr>'; }
            } catch (e) { showToast('Lỗi tải danh sách: ' + e.message, 'error'); }
            showLoading(false);
        }

        // --- SLIDESHOW LOGIC ---
        function renderSlideshowList() {
            if (cachedProfiles.length === 0) {
                loadProfilesList().then(() => renderSlideshowList());
                return;
            }
            const tbody = document.getElementById('slideshow-table-body');
            tbody.innerHTML = '';
            cachedProfiles.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="slide-check" value="${p.job_id}"></td>
                        <td class="fw-bold">${p.full_name}</td>
                        <td class="text-muted">${p.job_id}</td>
                    </tr>
                `;
            });
        }
        
        function toggleAllSlides(source) {
            const checkboxes = document.querySelectorAll('.slide-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function startSlideshow() {
            const checkboxes = document.querySelectorAll('.slide-check:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const interval = document.getElementById('slide-interval').value;

            if (selectedIds.length === 0) {
                showToast('Vui lòng chọn ít nhất 1 hồ sơ!', 'error');
                return;
            }
            // Mở trang slideshow.html
            const url = `slideshow.html?ids=${selectedIds.join(',')}&time=${interval}`;
            window.open(url, '_blank');
        }

        async function editProfile(jobId) {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/page/${jobId}`);
                const json = await res.json();
                const d = json.data;
                isEditMode = true;
                switchTab('create', false);
                
                document.getElementById('job_id').value = d.job_id;
                document.getElementById('job_id').readOnly = true; 
                document.getElementById('full_name').value = d.full_name;
                document.getElementById('date_range').value = d.date_range || '';
                document.getElementById('avatar_url').value = d.avatar_url || '';
                document.getElementById('cover_url').value = d.cover_url || '';
                if(typeof tinymce !== 'undefined' && tinymce.get('biography_editor')) tinymce.get('biography_editor').setContent(d.biography || '');
                
                const roleWrapper = document.getElementById('roles-wrapper'); roleWrapper.innerHTML = '';
                if(d.career_roles?.length) d.career_roles.forEach(r => addRoleRow(r));
                else roleWrapper.innerHTML = '<div class="text-center text-muted mt-5 empty-role-msg">Chưa có chức vụ nào.</div>';

                const locWrapper = document.getElementById('locations-wrapper'); locWrapper.innerHTML = '';
                if(d.locations?.length) d.locations.forEach(loc => addLocationRow(loc));
                else locWrapper.innerHTML = '<div class="text-center text-muted mt-5 empty-loc-msg">Chưa có địa điểm nào.</div>';

                document.getElementById('form-title').textContent = "Chỉnh sửa Hồ Sơ";
            } catch (e) { showToast('Lỗi tải hồ sơ', 'error'); showLoading(false); }
            showLoading(false);
        }

        function resetForm() {
            isEditMode = false;
            document.getElementById('profileForm').reset();
            document.getElementById('job_id').value = "";
            document.getElementById('job_id').readOnly = true; 
            document.getElementById('form-title').textContent = "Tạo Hồ Sơ Mới";
            if(tinymce.get('biography_editor')) tinymce.get('biography_editor').setContent('');
            document.getElementById('locations-wrapper').innerHTML = '<div class="text-center text-muted mt-5 empty-loc-msg">Chưa có địa điểm nào.</div>';
            document.getElementById('roles-wrapper').innerHTML = '<div class="text-center text-muted mt-5 empty-role-msg">Chưa có chức vụ nào.</div>';
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const payload = {
                job_id: document.getElementById('job_id').value,
                full_name: document.getElementById('full_name').value,
                date_range: document.getElementById('date_range').value,
                avatar_url: document.getElementById('avatar_url').value,
                cover_url: document.getElementById('cover_url').value,
                biography: (typeof tinymce !== 'undefined' && tinymce.get('biography_editor')) ? tinymce.get('biography_editor').getContent() : '',
                career_roles: getRolesFromUI(),
                locations: getLocationsFromUI()
            };
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/setup`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                const json = await res.json();
                if(json.ok) { showToast('Lưu thành công!', 'success'); switchTab('profiles'); }
                else showToast('Lỗi: ' + json.error, 'error');
            } catch(e) { showToast('Lỗi kết nối', 'error'); }
            showLoading(false);
        });

        async function manageTributes(jobId) {
            const modal = new bootstrap.Modal(document.getElementById('tributesModal'));
            modal.show();
            const tbody = document.getElementById('tributes-table-body');
            tbody.innerHTML = '<tr><td colspan="4">Đang tải...</td></tr>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/page/${jobId}`);
                const json = await res.json();
                const tributes = json.data.tributes;
                tbody.innerHTML = '';
                if(!tributes.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Trống</td></tr>'; return; }
                tributes.forEach(t => {
                    tbody.innerHTML += `<tr><td class="fw-bold text-wrap" style="max-width: 100px;">${t.sender_name}</td><td class="text-wrap" style="max-width: 200px;">${t.message}</td><td class="small text-nowrap">${new Date(t.created_at).toLocaleDateString()}</td><td><button class="btn btn-outline-danger btn-sm" onclick="deleteTribute(${t.id}, '${jobId}')"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } catch(e) {}
        }

        function deleteTribute(id, jobId) {
            showConfirm("Xóa tin nhắn này?", async () => {
                try {
                    await fetch(`${API_BASE_URL}/api/admin/tribute/${id}`, { method: 'DELETE' });
                    showToast('Đã xóa tin nhắn', 'success');
                    const modalEl = document.getElementById('tributesModal');
                    bootstrap.Modal.getInstance(modalEl).hide(); 
                    setTimeout(() => manageTributes(jobId), 300);
                } catch(e) { showToast('Lỗi xóa', 'error'); }
            });
        }

        function deleteProfile(jobId) {
            showConfirm(`Xóa vĩnh viễn hồ sơ [${jobId}]?`, async () => {
                try {
                    await fetch(`${API_BASE_URL}/api/admin/profile/${jobId}`, { method: 'DELETE' });
                    showToast('Đã xóa hồ sơ', 'success');
                    loadProfilesList();
                } catch(e) { showToast('Lỗi xóa hồ sơ', 'error'); }
            });
        }

        // TẢI ẢNH STANDEE (Giao diện Cũ - Dark)
        async function downloadStandeeOld(jobId) {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/page/${jobId}`);
                const json = await res.json();
                const data = json.data;
                document.getElementById('export-name-old').textContent = data.full_name;
                document.getElementById('export-years-old').textContent = data.date_range || '';
                const imgEl = document.getElementById('export-avatar-old');
                if(data.avatar_url) { imgEl.crossOrigin = "anonymous"; imgEl.src = data.avatar_url; } 
                else { imgEl.src = "https://via.placeholder.com/500x680?text=No+Image"; }
                const qrContainer = document.getElementById('export-qrcode-old');
                qrContainer.innerHTML = '';
                let baseUrl = window.location.href;
                if (baseUrl.endsWith(".html")) { baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf("/")); } 
                else if (baseUrl.endsWith("/")) { baseUrl = baseUrl.slice(0, -1); }
                const targetUrl = `${baseUrl}/profile.html?job=${jobId}`;
                new QRCode(qrContainer, { text: targetUrl, width: 240, height: 240, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
                const capture = () => {
                    setTimeout(() => {
                        html2canvas(document.getElementById("export-container-old"), { scale: 1, useCORS: true, allowTaint: true, backgroundColor: null, logging: false }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `Standee-${data.full_name}.png`;
                            link.href = canvas.toDataURL("image/png");
                            link.click();
                            showToast('Đã tải ảnh thành công!', 'success');
                            showLoading(false);
                        });
                    }, 100);
                };
                if (imgEl.complete) capture(); else { imgEl.onload = capture; imgEl.onerror = capture; }
            } catch (e) { showToast('Lỗi tạo ảnh: ' + e.message, 'error'); showLoading(false); }
        }

        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        
        loadProfilesList();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>