<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPHACO Admin | Qu·∫£n tr·ªã S·ªï Tang</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="CPH LOGO 1.png">
    
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --cph-blue: #0099D8;
            --cph-blue-dark: #007bb0;
            --sidebar-width: 260px;
            --sidebar-bg: #ffffff;
            --body-bg: #f8fafc;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--body-bg); color: #1e293b; overflow-x: hidden; }
        #biography_editor { height: 300px; }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background-color: var(--sidebar-bg); border-right: 1px solid #e2e8f0; 
            position: fixed; top: 0; left: 0; padding: 24px 16px; z-index: 1000; 
            display: flex; flex-direction: column; transition: transform 0.3s ease-in-out;
        }
        .brand-logo { text-decoration: none; display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .brand-logo img { height: 80px; object-fit: contain; margin-bottom: 10px; }
        .brand-text { font-family: 'Roboto', sans-serif; font-weight: 700; color: var(--cph-blue); font-size: 1.1rem; text-transform: uppercase; }
        .nav-link { color: #334155; padding: 14px 20px; border-radius: 8px; margin-bottom: 8px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background-color: #f1f5f9; color: var(--cph-blue); }
        .nav-link.active { background-color: #e0f2fe; color: var(--cph-blue); font-weight: 600; }

        /* MAIN */
        .main-wrapper { margin-left: var(--sidebar-width); padding: 40px; min-height: 100vh; transition: margin-left 0.3s ease-in-out; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: #0f172a; margin-bottom: 5px; }
        .card { background: white; border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04); margin-bottom: 24px; overflow: hidden; }
        .card-body { padding: 30px; }
        .btn-primary { background-color: var(--cph-blue); border-color: var(--cph-blue); }
        .btn-primary:hover { background-color: var(--cph-blue-dark); border-color: var(--cph-blue-dark); }

        /* TABLES & FORMS */
        .custom-table th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 15px 20px; white-space: nowrap; }
        .custom-table td { padding: 15px 20px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        .dynamic-row { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        
        /* UI UTILS */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1060; }
        .mobile-header { display: none; padding: 15px 20px; background: white; border-bottom: 1px solid #e2e8f0; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 900; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 990; }

        /* STANDEE EXPORT TEMPLATE (·∫®N) - Giao di·ªán c≈© (Dark) */
        #export-container-old {
            position: fixed; top: 0; left: -9999px; width: 1080px; height: 1920px; 
            background: linear-gradient(180deg, #101828 0%, #05080F 100%); 
            color: #ffffff; padding: 100px 80px; box-sizing: border-box; 
            font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; align-items: center;
            z-index: -100;
        }
        .standee-top-text { font-size: 48px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; color: #fbbf24; margin-bottom: 10px; }
        .standee-title { font-size: 72px; font-weight: 700; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 80px; color: #ffffff; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .st-portrait-frame { padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin-bottom: 50px; }
        .st-portrait { width: 500px; height: 680px; object-fit: cover; display: block; background: #000; }
        .st-info { text-align: center; margin-bottom: 20px; }
        .st-name { font-size: 64px; font-weight: 700; text-transform: uppercase; color: #ffffff; margin-bottom: 15px; }
        .st-years { font-size: 36px; color: #94a3b8; font-weight: 400; }
        .st-qr-section { margin-top: 20px; display: flex; justify-content: center; width: 100%; }
        .st-qr-text { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 20px; }
        .st-qr-box { background: #ffffff; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .st-qr-text h3 { font-size: 32px; color: #fbbf24; margin: 0; font-weight: 700; text-transform: uppercase; }
        .st-qr-text p { font-size: 20px; color: #e2e8f0; margin: 0; line-height: 1.5; }

        /* IMAGE UPLOAD */
        .upload-box { border: 2px dashed #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8fafc; position: relative; }
        .upload-box:hover { border-color: var(--cph-blue); background: #f0f9ff; }
        .upload-box.dragging { border-color: var(--cph-blue); background: #e0f2fe; }
        .upload-box input[type="file"] { display: none; }
        .upload-box .upload-icon { font-size: 2rem; color: #94a3b8; margin-bottom: 10px; }
        .upload-box .upload-text { color: #64748b; font-size: 0.9rem; }
        .upload-box .upload-text span { color: var(--cph-blue); font-weight: 600; }
        .upload-preview { position: relative; border-radius: 12px; overflow: hidden; }
        .upload-preview img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; }
        .upload-preview .remove-btn { position: absolute; top: 10px; right: 10px; background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .upload-progress { height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 10px; overflow: hidden; display: none; }
        .upload-progress .bar { height: 100%; background: var(--cph-blue); width: 0%; transition: width 0.3s; }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-wrapper { margin-left: 0; padding: 20px; margin-top: 60px; }
            .mobile-header { display: flex; }
            .sidebar-overlay.active { display: block; }
            .table-responsive { overflow-x: auto; }
            .dynamic-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>

<body>

    <div id="loading"><div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <div class="mobile-header">
        <div class="d-flex align-items-center gap-2">
            <img src="CPH LOGO 1.png" alt="Logo" style="height: 32px;">
            <span class="fw-bold text-primary">CPHACO ADMIN</span>
        </div>
        <button class="btn btn-light border" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="d-flex justify-content-between align-items-center d-lg-none mb-3">
            <span class="text-muted fw-bold">MENU</span>
            <button class="btn btn-sm btn-light" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <a href="#" class="brand-logo d-none d-lg-flex">
            <img src="CPH LOGO 1.png" alt="CPHACO Logo">
            <span class="brand-text">Admin Portal</span>
        </a>
        <div class="nav flex-column">
            <a id="nav-profiles" class="nav-link active" onclick="switchTab('profiles')"><i class="fas fa-list-alt"></i><span>Danh s√°ch H·ªì S∆°</span></a>
            <a id="nav-create" class="nav-link" onclick="switchTab('create', true)"><i class="fas fa-user-plus"></i><span>Th√™m M·ªõi / S·ª≠a</span></a>
            <a id="nav-slideshow" class="nav-link" onclick="switchTab('slideshow')"><i class="fas fa-play-circle"></i><span>C·∫•u h√¨nh Tr√¨nh chi·∫øu</span></a>
        </div>
        <div class="mt-auto d-lg-none text-center p-3 text-muted small border-top">
            &copy; 2025 CPHACO
        </div>
    </nav>

    <div class="main-wrapper">
        
        <div id="tab-profiles">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center page-header gap-3">
                <div><h1 class="page-title">Qu·∫£n l√Ω Trang T∆∞·ªüng Ni·ªám</h1><p class="text-muted mb-0">H·ªá th·ªëng S·ªï tang ƒëi·ªán t·ª≠.</p></div>
                <button class="btn btn-primary shadow-sm w-100 w-md-auto" onclick="switchTab('create', true)"><i class="fas fa-plus me-2"></i> T·∫°o m·ªõi</button>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table custom-table mb-0">
                        <thead><tr><th>#</th><th>M√£ H·ªì S∆°</th><th>Ng∆∞·ªùi m·∫•t</th><th>Ng√†y t·∫°o</th><th class="text-end">Thao t√°c</th></tr></thead>
                        <tbody id="profiles-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-create" style="display:none;">
            <div class="d-flex justify-content-between align-items-center page-header">
                <div><h1 class="page-title" id="form-title">T·∫°o H·ªì S∆° M·ªõi</h1><p class="text-muted d-none d-md-block">Nh·∫≠p th√¥ng tin chi ti·∫øt ƒë·ªÉ hi·ªÉn th·ªã.</p></div>
                <button class="btn btn-outline-secondary bg-white" onclick="switchTab('profiles')"><i class="fas fa-arrow-left me-2"></i> Quay l·∫°i</button>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <form id="profileForm">
                                <h5 class="mb-4 text-primary fw-bold">Th√¥ng tin c∆° b·∫£n</h5>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">M√£ H·ªì S∆° <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="job_id" placeholder="T·ª± ƒë·ªông t·∫°o..." required readonly>
                                        <div class="form-text text-muted small">M√£ d√πng cho link QR (Kh√¥ng s·ª≠a ƒë∆∞·ª£c).</div>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">H·ªç v√† T√™n <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control fw-bold" id="full_name" placeholder="VD: Ho√†ng Nam Ti·∫øn" required oninput="generateIdFromName(this.value)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Ni√™n kh√≥a</label>
                                        <input type="text" class="form-control" id="date_range" placeholder="1969 - 2025">
                                    </div>
                                </div>
                                <div class="row g-4 mb-5">
                                    <div class="col-md-6">
                                        <label class="form-label">·∫¢nh ch√¢n dung (Avatar)</label>
                                        <input type="hidden" id="avatar_url">
                                        <div id="avatar-upload-area">
                                            <div class="upload-box" onclick="document.getElementById('avatar_file').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'avatar')">
                                                <input type="file" id="avatar_file" accept="image/*" onchange="uploadImage(this, 'avatar')">
                                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                                <div class="upload-text"><span>Nh·∫•n ƒë·ªÉ ch·ªçn</span> ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y</div>
                                                <div class="upload-progress" id="avatar-progress"><div class="bar"></div></div>
                                            </div>
                                        </div>
                                        <div id="avatar-preview" class="upload-preview mt-2" style="display:none;">
                                            <img id="avatar-preview-img" src="">
                                            <button type="button" class="remove-btn" onclick="removeImage('avatar')"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">·∫¢nh b√¨a (Cover)</label>
                                        <input type="hidden" id="cover_url">
                                        <div id="cover-upload-area">
                                            <div class="upload-box" onclick="document.getElementById('cover_file').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'cover')">
                                                <input type="file" id="cover_file" accept="image/*" onchange="uploadImage(this, 'cover')">
                                                <div class="upload-icon"><i class="fas fa-image"></i></div>
                                                <div class="upload-text"><span>Nh·∫•n ƒë·ªÉ ch·ªçn</span> ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y</div>
                                                <div class="upload-progress" id="cover-progress"><div class="bar"></div></div>
                                            </div>
                                        </div>
                                        <div id="cover-preview" class="upload-preview mt-2" style="display:none;">
                                            <img id="cover-preview-img" src="">
                                            <button type="button" class="remove-btn" onclick="removeImage('cover')"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <h5 class="mb-4 text-primary fw-bold">N·ªôi dung chi ti·∫øt</h5>
                                <div class="mb-4"><label class="form-label">Ti·ªÉu s·ª≠ (Web)</label><div id="biography_editor"></div></div>
                                <div class="row g-4 mb-4">
                                    <div class="col-lg-6">
                                        <label class="form-label d-flex justify-content-between align-items-center">
                                            Danh s√°ch Ch·ª©c v·ª• (TV)
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRoleRow()"><i class="fas fa-plus"></i> Th√™m</button>
                                        </label>
                                        <div id="roles-wrapper" class="border rounded p-3 bg-white" style="min-height: 200px; max-height: 400px; overflow-y: auto;"></div>
                                    </div>
                                    <div class="col-lg-6">
                                        <label class="form-label d-flex justify-content-between align-items-center">
                                            ƒê·ªãa ƒëi·ªÉm t·ªï ch·ª©c (TV)
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLocationRow()"><i class="fas fa-plus"></i> Th√™m</button>
                                        </label>
                                        <div id="locations-wrapper" class="border rounded p-3 bg-white" style="min-height: 200px; max-height: 400px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end gap-2 pt-4 border-top">
                                    <button type="button" class="btn btn-light px-4" onclick="switchTab('profiles')">H·ªßy</button>
                                    <button type="submit" class="btn btn-primary px-5 shadow w-100 w-md-auto">L∆∞u H·ªì S∆°</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-slideshow" style="display:none;">
            <div class="d-flex justify-content-between align-items-center page-header">
                <div><h1 class="page-title">C·∫•u h√¨nh Tr√¨nh Chi·∫øu</h1><p class="text-muted">Ch·ªçn c√°c h·ªì s∆° ƒë·ªÉ hi·ªÉn th·ªã li√™n t·ª•c tr√™n m√†n h√¨nh Standee.</p></div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="mb-3 fw-bold text-primary">Danh s√°ch h·ªì s∆°</h5>
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table custom-table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50"><input type="checkbox" id="check-all" onclick="toggleAllSlides(this)"></th>
                                            <th>Ng∆∞·ªùi m·∫•t</th>
                                            <th>M√£ H·ªì s∆°</th>
                                        </tr>
                                    </thead>
                                    <tbody id="slideshow-table-body">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="mb-3 fw-bold text-primary">C√†i ƒë·∫∑t ph√°t</h5>
                            <div class="mb-3">
                                <label class="form-label">Ki·ªÉu giao di·ªán</label>
                                <select id="slide-style" class="form-select">
                                    <option value="standee">üé® Standee (T·ªëi - M√†n h√¨nh d·ªçc)</option>
                                    <option value="profile">üìÑ Profile (S√°ng - ƒê·∫ßy ƒë·ªß th√¥ng tin)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Th·ªùi gian m·ªói trang (gi√¢y)</label>
                                <input type="number" id="slide-interval" class="form-control" value="30" min="5">
                            </div>
                            <div class="alert alert-info small mb-3" id="style-hint">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Standee:</strong> Giao di·ªán t·ªëi, thi·∫øt k·∫ø d·ªçc 9:16, ph√π h·ª£p m√†n h√¨nh Standee/TV d·ªçc.
                            </div>
                            <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" onclick="startSlideshow()">
                                <i class="fas fa-play me-2"></i> B·∫ÆT ƒê·∫¶U TR√åNH CHI·∫æU
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="tributesModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-light"><h5 class="modal-title fw-bold text-dark">Qu·∫£n l√Ω S·ªï Tang</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="table-responsive" style="height: 100%; max-height: 70vh; overflow-y: auto;"><table class="table custom-table table-striped mb-0"><thead><tr><th>Ng∆∞·ªùi g·ª≠i</th><th>N·ªôi dung</th><th>Ng√†y</th><th></th></tr></thead><tbody id="tributes-table-body"></tbody></table></div></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0"><h5 class="modal-title text-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>X√°c nh·∫≠n x√≥a</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="mb-0 text-muted" id="confirm-message">...</p></div><div class="modal-footer border-0 justify-content-center pb-4"><button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">H·ªßy</button><button type="button" class="btn btn-danger px-4" id="btn-confirm-action">X√≥a ngay</button></div></div></div></div>

    <div id="export-container-old">
        <div class="standee-top-text">HOA VI√äN B√åNH D∆Ø∆†NG</div>
        <div class="standee-title">T∆Ø·ªûNG NI·ªÜM</div>
        <div class="st-portrait-frame"><img id="export-avatar-old" class="st-portrait" src="" alt="Avatar"></div>
        <div class="st-info"><div class="st-name" id="export-name-old">...</div><div class="st-years" id="export-years-old">...</div></div>
        <div class="st-qr-section"><div class="st-qr-text"><h3>S·ªî TANG ƒêI·ªÜN T·ª¨</h3><div class="st-qr-box" id="export-qrcode-old"></div><p>Qu√©t m√£ ƒë·ªÉ g·ª≠i l·ªùi chia bu·ªìn<br>Scan to visit memorial page</p></div></div>
    </div>

    <script>
        const API_BASE_URL = "https://cphaco-backend-api.onrender.com"; 
        const CLOUDINARY_CLOUD_NAME = "dmeljhntk";
        const CLOUDINARY_UPLOAD_PRESET = "standee-cph";
        let isEditMode = false; 
        let cachedProfiles = []; 

        // --- CLOUDINARY UPLOAD FUNCTIONS ---
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragging');
        }
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragging');
        }
        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragging');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                uploadToCloudinary(file, type);
            } else {
                showToast('Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
            }
        }
        function uploadImage(input, type) {
            const file = input.files[0];
            if (file) {
                uploadToCloudinary(file, type);
            }
        }
        async function uploadToCloudinary(file, type) {
            const progressBar = document.getElementById(`${type}-progress`);
            const progressFill = progressBar.querySelector('.bar');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`);
                
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressFill.style.width = percent + '%';
                    }
                };

                xhr.onload = () => {
                    progressBar.style.display = 'none';
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        const imageUrl = response.secure_url;
                        document.getElementById(`${type}_url`).value = imageUrl;
                        document.getElementById(`${type}-upload-area`).style.display = 'none';
                        document.getElementById(`${type}-preview`).style.display = 'block';
                        document.getElementById(`${type}-preview-img`).src = imageUrl;
                        showToast('T·∫£i ·∫£nh th√†nh c√¥ng!', 'success');
                    } else {
                        showToast('L·ªói t·∫£i ·∫£nh: ' + xhr.statusText, 'error');
                    }
                };

                xhr.onerror = () => {
                    progressBar.style.display = 'none';
                    showToast('L·ªói k·∫øt n·ªëi!', 'error');
                };

                xhr.send(formData);
            } catch (e) {
                progressBar.style.display = 'none';
                showToast('L·ªói: ' + e.message, 'error');
            }
        }
        function removeImage(type) {
            document.getElementById(`${type}_url`).value = '';
            document.getElementById(`${type}-upload-area`).style.display = 'block';
            document.getElementById(`${type}-preview`).style.display = 'none';
            document.getElementById(`${type}-preview-img`).src = '';
            document.getElementById(`${type}_file`).value = '';
        }
        function setImagePreview(type, url) {
            if (url) {
                document.getElementById(`${type}_url`).value = url;
                document.getElementById(`${type}-upload-area`).style.display = 'none';
                document.getElementById(`${type}-preview`).style.display = 'block';
                document.getElementById(`${type}-preview-img`).src = url;
            } else {
                removeImage(type);
            }
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
        document.querySelector('.sidebar-overlay').addEventListener('click', toggleSidebar);

        // Kh·ªüi t·∫°o Quill Editor
        const quill = new Quill('#biography_editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link'],
                    ['clean']
                ]
            },
            placeholder: 'Nh·∫≠p ti·ªÉu s·ª≠...'
        });

        function generateIdFromName(name) {
            const idInput = document.getElementById('job_id');
            if (isEditMode) return; 
            let slug = name.toLowerCase();
            slug = slug.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
            slug = slug.replace(/[ƒëƒê]/g, 'd'); 
            slug = slug.replace(/[^a-z0-9]/g, ''); 
            idInput.value = slug;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            const colorClass = type === 'success' ? 'bg-success' : 'bg-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            container.insertAdjacentHTML('beforeend', `<div id="${id}" class="toast align-items-center text-white ${colorClass} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body"><i class="fas ${icon} me-2"></i> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`);
            const toastEl = document.getElementById(id); const toast = new bootstrap.Toast(toastEl, { delay: 3000 }); toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        let confirmCallback = null;
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }
        document.getElementById('btn-confirm-action').addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
            const el = document.getElementById('confirmModal');
            const modal = bootstrap.Modal.getInstance(el);
            if (modal) modal.hide();
        });

        // HELPERS
        function addLocationRow(data = null) {
            const wrapper = document.getElementById('locations-wrapper');
            if(wrapper.querySelector('.empty-loc-msg')) wrapper.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'dynamic-row flex-column align-items-stretch';
            div.innerHTML = `<div class="d-flex justify-content-between align-items-start mb-2"><strong class="text-primary small"># ƒê·ªãa ƒëi·ªÉm</strong><button type="button" class="btn-remove-row" onclick="this.closest('.dynamic-row').remove()"><i class="fas fa-trash-alt"></i></button></div><div class="row g-2"><div class="col-md-6"><input type="text" class="form-control form-control-sm loc-name" placeholder="T√™n" value="${data ? data.name : ''}"></div><div class="col-md-6"><input type="text" class="form-control form-control-sm loc-time" placeholder="Gi·ªù" value="${data ? data.time : ''}"></div><div class="col-12"><input type="text" class="form-control form-control-sm loc-addr" placeholder="ƒê·ªãa ch·ªâ" value="${data ? data.address : ''}"></div></div>`;
            wrapper.appendChild(div);
        }
        function getLocationsFromUI() {
            const locs = [];
            document.querySelectorAll('#locations-wrapper .dynamic-row').forEach(row => {
                const name = row.querySelector('.loc-name').value.trim();
                if(name) locs.push({ name, time: row.querySelector('.loc-time').value.trim(), address: row.querySelector('.loc-addr').value.trim() });
            });
            return locs;
        }
        function addRoleRow(roleText = "") {
            const wrapper = document.getElementById('roles-wrapper');
            if(wrapper.querySelector('.empty-role-msg')) wrapper.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'dynamic-row'; 
            div.innerHTML = `<input type="text" class="form-control form-control-sm role-input w-100" placeholder="Ch·ª©c v·ª•..." value="${roleText}"><button type="button" class="btn-remove-row" onclick="this.closest('.dynamic-row').remove()"><i class="fas fa-times"></i></button>`;
            wrapper.appendChild(div);
        }
        function getRolesFromUI() {
            const roles = [];
            document.querySelectorAll('#roles-wrapper .role-input').forEach(input => { if(input.value.trim()) roles.push(input.value.trim()); });
            return roles;
        }

        // --- APP LOGIC ---
        function switchTab(tabName, forceReset = false) {
            document.querySelectorAll('.main-wrapper > div').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            if (window.innerWidth < 992) {
                document.querySelector('.sidebar').classList.remove('active');
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }

            if (tabName === 'profiles') {
                document.getElementById('tab-profiles').style.display = 'block';
                document.getElementById('nav-profiles').classList.add('active');
                loadProfilesList();
            } else if (tabName === 'create') {
                document.getElementById('tab-create').style.display = 'block';
                document.getElementById('nav-create').classList.add('active');
                if(forceReset || !document.getElementById('job_id').value) resetForm();
            } else if (tabName === 'slideshow') {
                document.getElementById('tab-slideshow').style.display = 'block';
                document.getElementById('nav-slideshow').classList.add('active');
                renderSlideshowList();
            }
        }

        async function loadProfilesList() {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/profiles`);
                const json = await res.json();
                cachedProfiles = json.items || []; 
                const tbody = document.getElementById('profiles-table-body');
                tbody.innerHTML = '';
                if (cachedProfiles.length > 0) {
                    cachedProfiles.forEach((p, index) => {
                        tbody.innerHTML += `
                        <tr>
                            <td class="text-muted fw-bold">${index + 1}</td>
                            <td>
                                <span class="badge bg-light text-dark border text-truncate" style="max-width: 100px;">${p.job_id}</span>
                                <div class="mt-1 d-flex gap-2">
                                    <a href="profile.html?job=${p.job_id}" target="_blank" class="text-decoration-none small"><i class="fas fa-link"></i> Web</a>
                                </div>
                            </td>
                            <td class="fw-bold text-primary">${p.full_name}</td>
                            <td class="text-muted small d-none d-md-table-cell">${new Date(p.created_at).toLocaleDateString('vi-VN')}</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-light btn-sm text-warning border" onclick="downloadStandeeOld('${p.job_id}')" title="T·∫£i ·∫£nh Standee (C≈©)">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="btn btn-light btn-sm text-primary" onclick="editProfile('${p.job_id}')"><i class="fas fa-pen"></i></button>
                                    <button class="btn btn-light btn-sm text-warning" onclick="manageTributes('${p.job_id}')"><i class="fas fa-comment-dots"></i></button>
                                    <button class="btn btn-light btn-sm text-danger" onclick="deleteProfile('${p.job_id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    });
                } else { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; }
            } catch (e) { showToast('L·ªói t·∫£i danh s√°ch: ' + e.message, 'error'); }
            showLoading(false);
        }

        // --- SLIDESHOW LOGIC ---
        function renderSlideshowList() {
            if (cachedProfiles.length === 0) {
                loadProfilesList().then(() => renderSlideshowList());
                return;
            }
            const tbody = document.getElementById('slideshow-table-body');
            tbody.innerHTML = '';
            cachedProfiles.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="slide-check" value="${p.job_id}"></td>
                        <td class="fw-bold">${p.full_name}</td>
                        <td class="text-muted">${p.job_id}</td>
                    </tr>
                `;
            });
        }
        
        function toggleAllSlides(source) {
            const checkboxes = document.querySelectorAll('.slide-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        // C·∫≠p nh·∫≠t hint khi thay ƒë·ªïi ki·ªÉu giao di·ªán
        document.getElementById('slide-style').addEventListener('change', function() {
            const hint = document.getElementById('style-hint');
            if (this.value === 'standee') {
                hint.className = 'alert alert-info small mb-3';
                hint.innerHTML = '<i class="fas fa-info-circle me-1"></i><strong>Standee:</strong> Giao di·ªán t·ªëi, thi·∫øt k·∫ø d·ªçc 9:16, ph√π h·ª£p m√†n h√¨nh Standee/TV d·ªçc.';
            } else {
                hint.className = 'alert alert-success small mb-3';
                hint.innerHTML = '<i class="fas fa-info-circle me-1"></i><strong>Profile:</strong> Giao di·ªán s√°ng, hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin, c√≥ QR code, ph√π h·ª£p m·ªçi m√†n h√¨nh.';
            }
        });

        function startSlideshow() {
            const checkboxes = document.querySelectorAll('.slide-check:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const interval = document.getElementById('slide-interval').value;
            const style = document.getElementById('slide-style').value;

            if (selectedIds.length === 0) {
                showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ªì s∆°!', 'error');
                return;
            }
            
            // Ch·ªçn file tr√¨nh chi·∫øu theo ki·ªÉu giao di·ªán
            const slideshowFile = style === 'profile' ? 'slideshow-profile.html' : 'slideshow.html';
            const url = `${slideshowFile}?ids=${selectedIds.join(',')}&time=${interval}`;
            window.open(url, '_blank');
        }

        async function editProfile(jobId) {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/page/${jobId}`);
                const json = await res.json();
                const d = json.data;
                isEditMode = true;
                switchTab('create', false);
                
                document.getElementById('job_id').value = d.job_id;
                document.getElementById('job_id').readOnly = true; 
                document.getElementById('full_name').value = d.full_name;
                document.getElementById('date_range').value = d.date_range || '';
                setImagePreview('avatar', d.avatar_url || '');
                setImagePreview('cover', d.cover_url || '');
                quill.root.innerHTML = d.biography || '';
                
                const roleWrapper = document.getElementById('roles-wrapper'); roleWrapper.innerHTML = '';
                if(d.career_roles?.length) d.career_roles.forEach(r => addRoleRow(r));
                else roleWrapper.innerHTML = '<div class="text-center text-muted mt-5 empty-role-msg">Ch∆∞a c√≥ ch·ª©c v·ª• n√†o.</div>';

                const locWrapper = document.getElementById('locations-wrapper'); locWrapper.innerHTML = '';
                if(d.locations?.length) d.locations.forEach(loc => addLocationRow(loc));
                else locWrapper.innerHTML = '<div class="text-center text-muted mt-5 empty-loc-msg">Ch∆∞a c√≥ ƒë·ªãa ƒëi·ªÉm n√†o.</div>';

                document.getElementById('form-title').textContent = "Ch·ªânh s·ª≠a H·ªì S∆°";
            } catch (e) { showToast('L·ªói t·∫£i h·ªì s∆°', 'error'); showLoading(false); }
            showLoading(false);
        }

        function resetForm() {
            isEditMode = false;
            document.getElementById('profileForm').reset();
            document.getElementById('job_id').value = "";
            document.getElementById('job_id').readOnly = true; 
            document.getElementById('form-title').textContent = "T·∫°o H·ªì S∆° M·ªõi";
            quill.root.innerHTML = '';
            removeImage('avatar');
            removeImage('cover');
            document.getElementById('locations-wrapper').innerHTML = '<div class="text-center text-muted mt-5 empty-loc-msg">Ch∆∞a c√≥ ƒë·ªãa ƒëi·ªÉm n√†o.</div>';
            document.getElementById('roles-wrapper').innerHTML = '<div class="text-center text-muted mt-5 empty-role-msg">Ch∆∞a c√≥ ch·ª©c v·ª• n√†o.</div>';
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const payload = {
                job_id: document.getElementById('job_id').value,
                full_name: document.getElementById('full_name').value,
                date_range: document.getElementById('date_range').value,
                avatar_url: document.getElementById('avatar_url').value,
                cover_url: document.getElementById('cover_url').value,
                biography: quill.root.innerHTML,
                career_roles: getRolesFromUI(),
                locations: getLocationsFromUI()
            };
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/setup`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                const json = await res.json();
                if(json.ok) { showToast('L∆∞u th√†nh c√¥ng!', 'success'); switchTab('profiles'); }
                else showToast('L·ªói: ' + json.error, 'error');
            } catch(e) { showToast('L·ªói k·∫øt n·ªëi', 'error'); }
            showLoading(false);
        });

        async function manageTributes(jobId) {
            const modal = new bootstrap.Modal(document.getElementById('tributesModal'));
            modal.show();
            const tbody = document.getElementById('tributes-table-body');
            tbody.innerHTML = '<tr><td colspan="4">ƒêang t·∫£i...</td></tr>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/page/${jobId}`);
                const json = await res.json();
                const tributes = json.data.tributes;
                tbody.innerHTML = '';
                if(!tributes.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Tr·ªëng</td></tr>'; return; }
                tributes.forEach(t => {
                    tbody.innerHTML += `<tr><td class="fw-bold text-wrap" style="max-width: 100px;">${t.sender_name}</td><td class="text-wrap" style="max-width: 200px;">${t.message}</td><td class="small text-nowrap">${new Date(t.created_at).toLocaleDateString()}</td><td><button class="btn btn-outline-danger btn-sm" onclick="deleteTribute(${t.id}, '${jobId}')"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            } catch(e) {}
        }

        function deleteTribute(id, jobId) {
            showConfirm("X√≥a tin nh·∫Øn n√†y?", async () => {
                try {
                    await fetch(`${API_BASE_URL}/api/admin/tribute/${id}`, { method: 'DELETE' });
                    showToast('ƒê√£ x√≥a tin nh·∫Øn', 'success');
                    const modalEl = document.getElementById('tributesModal');
                    bootstrap.Modal.getInstance(modalEl).hide(); 
                    setTimeout(() => manageTributes(jobId), 300);
                } catch(e) { showToast('L·ªói x√≥a', 'error'); }
            });
        }

        function deleteProfile(jobId) {
            showConfirm(`X√≥a vƒ©nh vi·ªÖn h·ªì s∆° [${jobId}]?`, async () => {
                try {
                    await fetch(`${API_BASE_URL}/api/admin/profile/${jobId}`, { method: 'DELETE' });
                    showToast('ƒê√£ x√≥a h·ªì s∆°', 'success');
                    loadProfilesList();
                } catch(e) { showToast('L·ªói x√≥a h·ªì s∆°', 'error'); }
            });
        }

        // T·∫¢I ·∫¢NH STANDEE (Giao di·ªán C≈© - Dark)
        async function downloadStandeeOld(jobId) {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE_URL}/api/memorial/page/${jobId}`);
                const json = await res.json();
                const data = json.data;
                document.getElementById('export-name-old').textContent = data.full_name;
                document.getElementById('export-years-old').textContent = data.date_range || '';
                const imgEl = document.getElementById('export-avatar-old');
                if(data.avatar_url) { imgEl.crossOrigin = "anonymous"; imgEl.src = data.avatar_url; } 
                else { imgEl.src = "https://via.placeholder.com/500x680?text=No+Image"; }
                const qrContainer = document.getElementById('export-qrcode-old');
                qrContainer.innerHTML = '';
                let baseUrl = window.location.href;
                if (baseUrl.endsWith(".html")) { baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf("/")); } 
                else if (baseUrl.endsWith("/")) { baseUrl = baseUrl.slice(0, -1); }
                const targetUrl = `${baseUrl}/profile.html?job=${jobId}`;
                new QRCode(qrContainer, { text: targetUrl, width: 240, height: 240, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
                const capture = () => {
                    setTimeout(() => {
                        html2canvas(document.getElementById("export-container-old"), { scale: 1, useCORS: true, allowTaint: true, backgroundColor: null, logging: false }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `Standee-${data.full_name}.png`;
                            link.href = canvas.toDataURL("image/png");
                            link.click();
                            showToast('ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng!', 'success');
                            showLoading(false);
                        });
                    }, 100);
                };
                if (imgEl.complete) capture(); else { imgEl.onload = capture; imgEl.onerror = capture; }
            } catch (e) { showToast('L·ªói t·∫°o ·∫£nh: ' + e.message, 'error'); showLoading(false); }
        }

        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        
        loadProfilesList();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>