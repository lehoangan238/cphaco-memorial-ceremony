<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Trình Chiếu - Giao diện Profile</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="CPH LOGO 1.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        
        .slideshow-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .slide-frame {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
        }
        
        .slide-frame.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Progress bar */
        .progress-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Controls overlay */
        .controls-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        body:hover .controls-overlay {
            opacity: 1;
        }
        
        .control-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .control-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        /* Slide counter */
        .slide-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        body:hover .slide-counter {
            opacity: 1;
        }

        /* 2. CSS CHO QR CODE OVERLAY */
        .qr-overlay {
            position: fixed;
            bottom: 20px; /* Cách đáy 20px */
            right: 20px;  /* Cách phải 20px (hoặc left nếu muốn) */
            background: white;
            padding: 10px;
            border-radius: 10px;
            z-index: 1002; /* Cao hơn các thành phần khác */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8; /* Mờ nhẹ để không che quá nhiều */
            transition: opacity 0.3s;
        }

        .qr-overlay:hover {
            opacity: 1;
        }

        .qr-text {
            color: #000;
            font-size: 10px;
            margin-top: 5px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #101828 0%, #05080F 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
        }
        
        .loading-screen.hidden {
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Đang tải trình chiếu...</div>
    </div>

    <div class="slideshow-container" id="slideshowContainer">
        </div>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div class="slide-counter" id="slideCounter">
        <span id="currentSlide">1</span> / <span id="totalSlides">1</span>
    </div>

    <div class="qr-overlay" id="qrOverlay">
        <div id="qrCodeCanvas"></div>
        <div class="qr-text">Sổ tang điện tử</div>
    </div>
    
    <div class="controls-overlay">
        <button class="control-btn" onclick="prevSlide()">
            ◀ Trước
        </button>
        <button class="control-btn" id="playPauseBtn" onclick="togglePause()">
            ⏸ Tạm dừng
        </button>
        <button class="control-btn" onclick="nextSlide()">
            Sau ▶
        </button>
        <button class="control-btn" onclick="exitSlideshow()">
            ✕ Thoát
        </button>
    </div>

    <script>
        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const jobIds = params.get("ids") ? params.get("ids").split(",") : [];
        const intervalTime = parseInt(params.get("time")) || 30; // seconds
        
        let currentIndex = 0;
        let isPaused = false;
        let progressInterval = null;
        let slideTimeout = null;
        let progress = 0;
        
        // Get base URL for profile pages
        let baseUrl = window.location.href.split('?')[0];
        baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/'));
        
        // Initialize slideshow
        function initSlideshow() {
            if (jobIds.length === 0) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                        <div style="font-size: 20px;">Không có hồ sơ nào được chọn</div>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 30px; background: #fbbf24; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">Đóng</button>
                    </div>
                `;
                return;
            }
            
            const container = document.getElementById('slideshowContainer');
            document.getElementById('totalSlides').textContent = jobIds.length;
            
            // Create iframes for each profile
            jobIds.forEach((jobId, index) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'slide-frame';
                iframe.id = `slide-${index}`;
                // Truyền tham số slideshow=1 vào url
                iframe.src = `${baseUrl}/profile.html?job=${encodeURIComponent(jobId)}&slideshow=1`;
                
                if (index === 0) {
                    iframe.classList.add('active');
                }
                
                container.appendChild(iframe);
            });

            // 4. KHỞI TẠO QR CODE CHO SLIDE ĐẦU TIÊN
            updateQRCode(0);
            
            // Hide loading after first iframe loads
            const firstFrame = document.getElementById('slide-0');
            firstFrame.onload = () => {
                document.getElementById('loadingScreen').classList.add('hidden');
                startProgress();
            };
            
            // Fallback: hide loading after 3 seconds
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (!progressInterval) startProgress();
            }, 3000);
        }

        // 5. HÀM CẬP NHẬT QR CODE
        function updateQRCode(index) {
            const qrContainer = document.getElementById("qrCodeCanvas");
            qrContainer.innerHTML = ""; // Xóa QR cũ
            
            if (jobIds[index]) {
                const jobId = jobIds[index];
                // Link trỏ về trang profile của user đó
                const targetUrl = `${baseUrl}/profile.html?job=${encodeURIComponent(jobId)}`;
                
                new QRCode(qrContainer, {
                    text: targetUrl,
                    width: 120,  // Kích thước QR
                    height: 120,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
            }
        }
        
        // Start progress bar
        function startProgress() {
            if (progressInterval) clearInterval(progressInterval);
            if (slideTimeout) clearTimeout(slideTimeout);
            
            progress = 0;
            const progressBar = document.getElementById('progressBar');
            const updateInterval = 100; // Update every 100ms
            const totalSteps = (intervalTime * 1000) / updateInterval;
            const stepSize = 100 / totalSteps;
            
            progressInterval = setInterval(() => {
                if (!isPaused) {
                    progress += stepSize;
                    progressBar.style.width = progress + '%';
                    
                    if (progress >= 100) {
                        nextSlide();
                    }
                }
            }, updateInterval);
        }
        
        // Navigate to next slide
        function nextSlide() {
            const prevIndex = currentIndex;
            currentIndex = (currentIndex + 1) % jobIds.length;
            transitionSlide(prevIndex, currentIndex);
        }
        
        // Navigate to previous slide
        function prevSlide() {
            const prevIndex = currentIndex;
            currentIndex = (currentIndex - 1 + jobIds.length) % jobIds.length;
            transitionSlide(prevIndex, currentIndex);
        }
        
        // Transition between slides
        function transitionSlide(from, to) {
            const fromFrame = document.getElementById(`slide-${from}`);
            const toFrame = document.getElementById(`slide-${to}`);
            
            fromFrame.classList.remove('active');
            toFrame.classList.add('active');
            
            document.getElementById('currentSlide').textContent = to + 1;
            
            // 6. CẬP NHẬT QR KHI CHUYỂN SLIDE
            updateQRCode(to);

            // Reset and restart progress
            progress = 0;
            document.getElementById('progressBar').style.width = '0%';
            startProgress();
        }
        
        // Toggle pause/play
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('playPauseBtn');
            btn.innerHTML = isPaused ? '▶ Tiếp tục' : '⏸ Tạm dừng';
        }
        
        // Exit slideshow
        function exitSlideshow() {
            window.close();
            // Fallback if window.close() doesn't work
            window.location.href = 'index.html';
        }
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                    prevSlide();
                    break;
                case 'ArrowRight':
                    nextSlide();
                    break;
                case ' ':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'Escape':
                    exitSlideshow();
                    break;
            }
        });
        
        // Initialize on load
        initSlideshow();
    </script>
</body>
</html>