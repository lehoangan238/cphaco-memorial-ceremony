<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Trình Chiếu - Giao diện Profile</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="CPH LOGO 1.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        
        .slideshow-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .slide-frame {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
        }
        
        .slide-frame.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Progress bar */
        .progress-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Controls overlay */
        .controls-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        body:hover .controls-overlay {
            opacity: 1;
        }
        
        .control-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .control-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        /* Slide counter */
        .slide-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        body:hover .slide-counter {
            opacity: 1;
        }

        /* Loading screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #101828 0%, #05080F 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            color: white;
        }
        
        .loading-screen.hidden {
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Đang tải trình chiếu...</div>
    </div>

    <div class="slideshow-container" id="slideshowContainer">
        </div>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div class="slide-counter" id="slideCounter">
        <span id="currentSlide">1</span> / <span id="totalSlides">1</span>
    </div>
    
    <div class="controls-overlay">
        <button class="control-btn" onclick="prevSlide()">
            ◀ Trước
        </button>
        <button class="control-btn" id="playPauseBtn" onclick="togglePause()">
            ⏸ Tạm dừng
        </button>
        <button class="control-btn" onclick="nextSlide()">
            Sau ▶
        </button>
        <button class="control-btn" onclick="exitSlideshow()">
            ✕ Thoát
        </button>
    </div>

    <script>
        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const jobIds = params.get("ids") ? params.get("ids").split(",") : [];
        const intervalTime = parseInt(params.get("time")) || 30; // seconds
        
        let currentIndex = 0;
        let isPaused = false;
        let progressInterval = null;
        let slideTimeout = null;
        let progress = 0;
        
        // Get base URL
        let baseUrl = window.location.href.split('?')[0];
        baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/'));
        
        function initSlideshow() {
            if (jobIds.length === 0) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        <div style="font-size: 20px;">Không có hồ sơ nào được chọn</div>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 30px;">Đóng</button>
                    </div>
                `;
                return;
            }
            
            const container = document.getElementById('slideshowContainer');
            document.getElementById('totalSlides').textContent = jobIds.length;
            
            jobIds.forEach((jobId, index) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'slide-frame';
                iframe.id = `slide-${index}`;
                iframe.src = `${baseUrl}/profile.html?job=${encodeURIComponent(jobId)}&slideshow=1`;
                
                // Khi iframe load xong thì mới chọc vào sửa QR được
                iframe.onload = () => {
                    injectQRToIframe(index); // Gọi hàm bơm QR
                    if (index === 0) {
                         document.getElementById('loadingScreen').classList.add('hidden');
                         startProgress();
                    }
                };

                if (index === 0) {
                    iframe.classList.add('active');
                }
                
                container.appendChild(iframe);
            });
            
            // Fallback
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (!progressInterval) startProgress();
            }, 3000);
        }

        // --- HÀM MỚI QUAN TRỌNG: CHỌC VÀO IFRAME ĐỂ THAY QR ---
        function injectQRToIframe(index) {
            const iframe = document.getElementById(`slide-${index}`);
            if (!iframe) return;

            try {
                // Lấy document bên trong iframe
                const innerDoc = iframe.contentWindow.document;
                
                // Tìm thẻ có ID là "hero-qr-container" BÊN TRONG trang profile
                // (Bạn phải chắc chắn bên file profile.html có thẻ <div id="hero-qr-container"></div> hoặc class tương ứng)
                const targetElement = innerDoc.getElementById("hero-qr-container") || innerDoc.querySelector(".hero-qr-container");

                if (targetElement) {
                    // 1. XÓA SẠCH CÁI CŨ (Canvas JS cũ)
                    targetElement.innerHTML = ""; 
                    targetElement.style.display = "flex";
                    targetElement.style.justifyContent = "center";
                    targetElement.style.alignItems = "center";
                    targetElement.style.flexDirection = "column";

                    // 2. TẠO QR MỚI BẰNG THƯ VIỆN CỦA TRANG MẸ
                    if (jobIds[index]) {
                        const jobId = jobIds[index];
                        const targetUrl = `${baseUrl}/profile.html?job=${encodeURIComponent(jobId)}`;
                        
                        // Tạo mã QR
                        new QRCode(targetElement, {
                            text: targetUrl,
                            width: 160,  // Kích thước QR bên trong profile
                            height: 160,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.M
                        });

                        // Thêm dòng chữ bên dưới (nếu cần giống mẫu)
                        const textNode = innerDoc.createElement("div");
                        textNode.innerText = "Quét để gửi lời chia buồn";
                        textNode.style.marginTop = "10px";
                        textNode.style.fontSize = "14px";
                        textNode.style.color = "#555";
                        textNode.style.textAlign = "center";
                        textNode.style.fontFamily = "Arial, sans-serif";
                        targetElement.appendChild(textNode);
                    }
                } else {
                    console.warn("Không tìm thấy thẻ #hero-qr-container bên trong iframe slide-" + index);
                }
            } catch (e) {
                console.error("Không thể truy cập iframe (có thể do lỗi CORS nếu chạy khác domain): ", e);
            }
        }
        
        function startProgress() {
            if (progressInterval) clearInterval(progressInterval);
            if (slideTimeout) clearTimeout(slideTimeout);
            
            progress = 0;
            const progressBar = document.getElementById('progressBar');
            const updateInterval = 100; 
            const totalSteps = (intervalTime * 1000) / updateInterval;
            const stepSize = 100 / totalSteps;
            
            progressInterval = setInterval(() => {
                if (!isPaused) {
                    progress += stepSize;
                    progressBar.style.width = progress + '%';
                    if (progress >= 100) nextSlide();
                }
            }, updateInterval);
        }
        
        function nextSlide() {
            const prevIndex = currentIndex;
            currentIndex = (currentIndex + 1) % jobIds.length;
            transitionSlide(prevIndex, currentIndex);
        }
        
        function prevSlide() {
            const prevIndex = currentIndex;
            currentIndex = (currentIndex - 1 + jobIds.length) % jobIds.length;
            transitionSlide(prevIndex, currentIndex);
        }
        
        function transitionSlide(from, to) {
            const fromFrame = document.getElementById(`slide-${from}`);
            const toFrame = document.getElementById(`slide-${to}`);
            
            fromFrame.classList.remove('active');
            toFrame.classList.add('active');
            
            document.getElementById('currentSlide').textContent = to + 1;
            
            // Đảm bảo QR đã được inject (phòng trường hợp load chậm)
            injectQRToIframe(to);
            
            progress = 0;
            document.getElementById('progressBar').style.width = '0%';
            startProgress();
        }
        
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('playPauseBtn');
            btn.innerHTML = isPaused ? '▶ Tiếp tục' : '⏸ Tạm dừng';
        }
        
        function exitSlideshow() {
            window.close();
            window.location.href = 'index.html';
        }
        
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft': prevSlide(); break;
                case 'ArrowRight': nextSlide(); break;
                case ' ': e.preventDefault(); togglePause(); break;
                case 'Escape': exitSlideshow(); break;
            }
        });
        
        initSlideshow();
    </script>
</body>
</html>